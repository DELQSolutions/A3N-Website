name: Deploy A3N Website

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            PROJECT_DIR="/var/www/a3n.delqsolutions.com"
            CONTAINER_NAME="a3n-consulting-web"
            
            echo "üöÄ Deploying A3N Website (will NOT affect other projects)"
            
            # Navigate to project directory
            cd $PROJECT_DIR
            
            # Pull latest changes
            echo "üì¶ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # Stop ONLY this project's container
            echo "üõë Stopping $CONTAINER_NAME..."
            docker-compose down
            
            # Clean up ONLY this project's images (safe)
            echo "üßπ Cleaning old A3N images..."
            docker images | grep "a3ndelqsolutionscom" | awk '{print $3}' | xargs -r docker rmi -f || true
            
            # Build new image
            echo "üî® Building new image..."
            docker-compose build --no-cache
            
            # Start new container
            echo "‚ñ∂Ô∏è  Starting $CONTAINER_NAME..."
            docker-compose up -d
            
            # Wait for startup
            echo "‚è≥ Waiting 10 seconds..."
            sleep 10
            
            # Verify all containers are still running
            echo "‚úÖ Verifying ALL containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Show this project's logs
            echo ""
            echo "üìã A3N Website logs:"
            docker-compose logs --tail=30
            
            echo ""
            echo "‚ú® Deployment completed!"
            
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/a3n.delqsolutions.com
            
            # Count running containers
            EXPECTED_CONTAINERS=4
            RUNNING_CONTAINERS=$(docker ps --format '{{.Names}}' | wc -l)
            
            echo "Running containers: $RUNNING_CONTAINERS/$EXPECTED_CONTAINERS"
            
            # Check A3N container
            if docker ps | grep -q "a3n-consulting-web"; then
              echo "‚úÖ a3n-consulting-web is running"
            else
              echo "‚ùå a3n-consulting-web is NOT running"
              exit 1
            fi
            
            # Check other containers are still running
            if docker ps | grep -q "wqtc_frontend"; then
              echo "‚úÖ wqtc_frontend still running"
            fi
            
            if docker ps | grep -q "wqtc_backend"; then
              echo "‚úÖ wqtc_backend still running"
            fi
            
            if docker ps | grep -q "wqtc_db"; then
              echo "‚úÖ wqtc_db still running"
            fi
            
            echo ""
            echo "üåê A3N Website: http://$(curl -s ifconfig.me):3001"
            echo "üåê WQTC Platform: http://$(curl -s ifconfig.me):3000"
